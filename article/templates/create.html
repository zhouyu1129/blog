{% extends 'base.html' %}
{% load static %}

{% block title %}创建文章 - 校园博客{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 col-lg-12 col-xl-12 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0"><i class="fas fa-pen mr-2"></i>创建新文章</h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label for="{{ form.title.id_for_label }}">文章标题</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.title.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.content.id_for_label }}">文章内容 (支持Markdown)</label>
                        <!-- 大屏幕：左右分栏，中等屏幕：上下排列，小屏幕：堆叠 -->
                        <div class="row">
                            <div class="col-12 col-lg-6 mb-3 mb-lg-0">
                                {{ form.content }}
                                {% if form.content.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.content.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-12 col-lg-6">
                                <label>预览</label>
                                <div id="markdown-preview" class="border p-3 rounded" style="min-height: 300px; max-height: 500px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> 发布文章
                        </button>
                        <a href="{% url 'article:article_list' %}" class="btn btn-secondary ml-2">
                            <i class="fas fa-arrow-left mr-1"></i> 返回列表
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle mr-2"></i>Markdown语法提示</h5>
            </div>
            <div class="card-body">
                <!-- 响应式布局：大屏幕两列，中等屏幕两列，小屏幕一列 -->
                <div class="row">
                    <div class="col-12 col-md-6 mb-3 mb-md-0">
                        <h6>基础语法</h6>
                        <ul class="list-unstyled small">
                            <li><code># 标题</code> - 一级标题</li>
                            <li><code>## 标题</code> - 二级标题</li>
                            <li><code>**粗体**</code> - <strong>粗体</strong></li>
                            <li><code>*斜体*</code> - <em>斜体</em></li>
                            <li><code>`代码`</code> - <code>代码</code></li>
                            <li><code>[链接](url)</code> - 链接</li>
                            <li><code>![图片](url)</code> - 图片</li>
                        </ul>
                    </div>
                    <div class="col-12 col-md-6">
                        <h6>高级语法</h6>
                        <ul class="list-unstyled small">
                            <li><code>- 列表项</code> - 无序列表</li>
                            <li><code>1. 列表项</code> - 有序列表</li>
                            <li><code>> 引用</code> - 引用块</li>
                            <li><code>```代码块```</code> - 代码块</li>
                            <li><code>--- 或 ***</code> - 分割线</li>
                            <li><code>|表头|表头|</code> - 表格</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* 响应式编辑器样式 */
@media (max-width: 991.98px) {
    /* 中等屏幕和小屏幕：调整编辑器和预览区域的高度 */
    #{{ form.content.id_for_label }} {
        min-height: 300px;
    }
    
    #markdown-preview {
        min-height: 200px;
        max-height: 400px;
    }
}

@media (max-width: 767.98px) {
    /* 小屏幕：进一步优化高度 */
    #{{ form.content.id_for_label }} {
        min-height: 250px;
    }
    
    #markdown-preview {
        min-height: 150px;
        max-height: 300px;
    }
}

/* 确保编辑器和预览区域在各种屏幕尺寸下都有合适的高度 */
#{{ form.content.id_for_label }} {
    min-height: 400px;
    resize: vertical; /* 允许垂直调整大小 */
}

#markdown-preview {
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
}

/* 优化按钮在小屏幕上的显示 */
@media (max-width: 575.98px) {
    .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
    
    .btn i {
        margin-right: 0.25rem !important;
    }
}
</style>

<script src="{% static 'js/marked/marked.min.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const contentField = document.getElementById('{{ form.content.id_for_label }}');
        const previewDiv = document.getElementById('markdown-preview');
        
        if (contentField && previewDiv) {
            // 创建字数统计显示元素
            const counter = document.createElement('div');
            counter.className = 'text-muted small mt-1';
            counter.textContent = '字数: 0';
            contentField.parentNode.appendChild(counter);
            
            // 配置marked选项
            marked.setOptions({
                breaks: true,  // 支持换行
                gfm: true,     // 支持GitHub风格的Markdown
                headerIds: true, // 为标题添加ID
                sanitize: false // 不清理HTML（允许自定义HTML）
            });
            
            // 更新预览和字数统计
            function updatePreview() {
                const text = contentField.value;
                previewDiv.innerHTML = marked.parse(text);
                
                // 更新字数统计
                const cleanText = text.replace(/\s/g, ''); // 去除空格
                counter.textContent = `字数: ${cleanText.length}`;
            }
            
            // 监听输入事件
            contentField.addEventListener('input', updatePreview);
            
            // 初始化预览
            updatePreview();
            
            // 响应式调整：监听窗口大小变化
            function adjustEditorHeight() {
                const windowHeight = window.innerHeight;
                const editorTop = contentField.getBoundingClientRect().top;
                const availableHeight = windowHeight - editorTop - 200; // 留出200px用于其他元素
                
                if (availableHeight > 250) {
                    contentField.style.minHeight = Math.min(availableHeight, 600) + 'px';
                    previewDiv.style.minHeight = Math.min(availableHeight, 600) + 'px';
                }
            }
            
            // 初始调整和监听窗口大小变化
            adjustEditorHeight();
            window.addEventListener('resize', adjustEditorHeight);
        }
    });
</script>
{% endblock %}