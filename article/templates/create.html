{% extends 'base.html' %}
{% load static %}

{% block title %}创建文章 - 校园博客{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 col-lg-12 col-xl-12 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0"><i class="fas fa-pen mr-2"></i>创建新文章</h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- 隐藏字段，用于存储之前上传的图片ID -->
                    <input type="hidden" id="previous_images" name="previous_images" value="">
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label for="{{ form.title.id_for_label }}">文章标题</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.title.errors }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.content.id_for_label }}">文章内容 (支持Markdown)</label>
                        <!-- 大屏幕：左右分栏，中等屏幕：上下排列，小屏幕：堆叠 -->
                        <div class="row">
                            <div class="col-12 col-lg-6 mb-3 mb-lg-0">
                                {{ form.content }}
                                {% if form.content.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.content.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-12 col-lg-6">
                                <label>预览</label>
                                <div id="markdown-preview" class="border p-3 rounded" style="min-height: 300px; max-height: 500px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="images">上传图片</label>
                        <div class="custom-file">
                            <input type="file" name="images" class="custom-file-input" id="images" multiple>
                            <label class="custom-file-label" for="images">选择图片文件...</label>
                        </div>
                        <small class="form-text text-muted">支持上传多张图片，可以使用 [[img_id=id]] 在文章中引用图片（id从1开始）</small>
                        
                        <!-- 图片预览区域 -->
                        <div id="image-preview-container" class="mt-3">
                            <div class="row" id="image-preview-row"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="file-upload">上传文件附件</label>
                        <div class="custom-file mb-3">
                            <input type="file" class="custom-file-input" id="file-upload" multiple>
                            <label class="custom-file-label" for="file-upload">选择文件...</label>
                        </div>
                        <small class="form-text text-muted">支持上传多个文件，单个文件不超过100MB。上传的文件将在发布文章时与文章关联。</small>
                        
                        <!-- 文件上传进度区域 -->
                        <div id="upload-progress-container" class="mt-3" style="display: none;">
                            <h6>上传进度</h6>
                            <div id="upload-progress-list"></div>
                        </div>
                        
                        <!-- 已上传文件列表 -->
                        <div id="uploaded-files-container" class="mt-3">
                            <h6>已上传文件</h6>
                            <div class="list-group" id="uploaded-files-list">
                                <!-- 临时文件将通过AJAX加载 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> 发布文章
                        </button>
                        <a href="{% url 'article:article_list' %}" class="btn btn-secondary ml-2">
                            <i class="fas fa-arrow-left mr-1"></i> 返回列表
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle mr-2"></i>Markdown语法提示</h5>
            </div>
            <div class="card-body">
                <!-- 响应式布局：大屏幕两列，中等屏幕两列，小屏幕一列 -->
                <div class="row">
                    <div class="col-12 col-md-6 mb-3 mb-md-0">
                        <h6>基础语法</h6>
                        <ul class="list-unstyled small">
                            <li><code># 标题</code> - 一级标题</li>
                            <li><code>## 标题</code> - 二级标题</li>
                            <li><code>**粗体**</code> - <strong>粗体</strong></li>
                            <li><code>*斜体*</code> - <em>斜体</em></li>
                            <li><code>`代码`</code> - <code>代码</code></li>
                            <li><code>[链接](url)</code> - 链接</li>
                            <li><code>![图片](url)</code> - 图片</li>
                            <li><code>[[img_id=1]]</code> - 引用上传的第1张图片</li>
                            <li><code>\[</code> / <code>\]</code> - 转义方括号</li>
                        </ul>
                    </div>
                    <div class="col-12 col-md-6">
                        <h6>高级语法</h6>
                        <ul class="list-unstyled small">
                            <li><code>- 列表项</code> - 无序列表</li>
                            <li><code>1. 列表项</code> - 有序列表</li>
                            <li><code>> 引用</code> - 引用块</li>
                            <li><code>```代码块```</code> - 代码块</li>
                            <li><code>--- 或 ***</code> - 分割线</li>
                            <li><code>|表头|表头|</code> - 表格</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* 响应式编辑器样式 */
@media (max-width: 991.98px) {
    /* 中等屏幕和小屏幕：调整编辑器和预览区域的高度 */
    #{{ form.content.id_for_label }} {
        min-height: 300px;
    }
    
    #markdown-preview {
        min-height: 200px;
        max-height: 400px;
    }
}

@media (max-width: 767.98px) {
    /* 小屏幕：进一步优化高度 */
    #{{ form.content.id_for_label }} {
        min-height: 250px;
    }
    
    #markdown-preview {
        min-height: 150px;
        max-height: 300px;
    }
}

/* 确保编辑器和预览区域在各种屏幕尺寸下都有合适的高度 */
#{{ form.content.id_for_label }} {
    min-height: 400px;
    resize: vertical; /* 允许垂直调整大小 */
}

#markdown-preview {
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
}

/* 图片预览区域样式 */
#image-preview-container {
    border: 1px dashed #ced4da;
    border-radius: 0.25rem;
    padding: 1rem;
    background-color: #f8f9fa;
}

#image-preview-container .card {
    transition: transform 0.2s;
}

#image-preview-container .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#image-preview-container .copy-ref-btn,
#image-preview-container .delete-img-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* 自定义文件上传样式 */
.custom-file {
    margin-bottom: 0.5rem;
}

.custom-file-input:focus ~ .custom-file-label {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.custom-file-label::after {
    content: "浏览";
}

/* 优化按钮在小屏幕上的显示 */
@media (max-width: 575.98px) {
    .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }
    
    .btn i {
        margin-right: 0.25rem !important;
    }
}
</style>

<script src="{% static 'js/marked/marked.min.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const contentField = document.getElementById('{{ form.content.id_for_label }}');
        const previewDiv = document.getElementById('markdown-preview');
        
        if (contentField && previewDiv) {
            // 创建字数统计显示元素
            const counter = document.createElement('div');
            counter.className = 'text-muted small mt-1';
            counter.textContent = '字数: 0';
            contentField.parentNode.appendChild(counter);
            
            // 配置marked选项
            marked.setOptions({
                breaks: true,  // 支持换行
                gfm: true,     // 支持GitHub风格的Markdown
                headerIds: true, // 为标题添加ID
                sanitize: false // 不清理HTML（允许自定义HTML）
            });
            
            // 更新预览和字数统计
            function updatePreview() {
                const text = contentField.value;
                previewDiv.innerHTML = marked.parse(text);
                
                // 更新字数统计
                const cleanText = text.replace(/\s/g, ''); // 去除空格
                counter.textContent = `字数: ${cleanText.length}`;
            }
            
            // 监听输入事件
            contentField.addEventListener('input', updatePreview);
            
            // 初始化预览
            updatePreview();
            
            // 响应式调整：监听窗口大小变化
            function adjustEditorHeight() {
                const windowHeight = window.innerHeight;
                const editorTop = contentField.getBoundingClientRect().top;
                const availableHeight = windowHeight - editorTop - 200; // 留出200px用于其他元素
                
                if (availableHeight > 250) {
                    contentField.style.minHeight = Math.min(availableHeight, 600) + 'px';
                    previewDiv.style.minHeight = Math.min(availableHeight, 600) + 'px';
                }
            }
            
            // 初始调整和监听窗口大小变化
            adjustEditorHeight();
            window.addEventListener('resize', adjustEditorHeight);
            
            // 图片预览和引用功能
            const imageInput = document.getElementById('images');
            const imagePreviewRow = document.getElementById('image-preview-row');
            const customFileLabel = document.querySelector('.custom-file-label');
            
            if (imageInput && imagePreviewRow) {
                let uploadedImages = [];
                let nextImageId = 1;
                
                // 监听文件选择
                imageInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    
                    // 更新文件名显示
                    if (files.length > 0) {
                        if (files.length === 1) {
                            customFileLabel.textContent = files[0].name;
                        } else {
                            customFileLabel.textContent = `已选择 ${files.length} 个文件`;
                        }
                    } else {
                        customFileLabel.textContent = '选择图片文件...';
                    }
                    
                    // 保留之前上传的图片，不清空预览
                    // imagePreviewRow.innerHTML = '';
                    // uploadedImages = [];
                    
                    // 为每个文件创建预览
                    files.forEach((file, index) => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            
                            reader.onload = function(e) {
                                // 计算新图片的ID
                                const imageId = nextImageId;
                                nextImageId++;
                                
                                uploadedImages.push({
                                    id: imageId,
                                    name: file.name,
                                    url: e.target.result,
                                    file: file // 保存文件对象的引用
                                });
                                
                                // 创建预览元素
                                const colDiv = document.createElement('div');
                                colDiv.className = 'col-md-4 col-sm-6 mb-3';
                                
                                colDiv.innerHTML = `
                                    <div class="card h-100">
                                        <img src="${e.target.result}" class="card-img-top" alt="预览" style="height: 150px; object-fit: cover;">
                                        <div class="card-body p-2">
                                            <h6 class="card-title small mb-1">${file.name}</h6>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge badge-primary">ID: ${imageId}</span>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary copy-ref-btn mr-1" data-id="${imageId}">
                                                        <i class="fas fa-copy"></i> 引用
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger delete-img-btn" data-id="${imageId}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                imagePreviewRow.appendChild(colDiv);
                                
                                // 添加引用按钮点击事件
                                const copyBtn = colDiv.querySelector('.copy-ref-btn');
                                copyBtn.addEventListener('click', function() {
                                    const refText = `[[img_id=${imageId}]]`;
                                    
                                    // 将引用文本插入到编辑器中光标位置
                                    const startPos = contentField.selectionStart;
                                    const endPos = contentField.selectionEnd;
                                    const beforeText = contentField.value.substring(0, startPos);
                                    const afterText = contentField.value.substring(endPos);
                                    
                                    contentField.value = beforeText + refText + afterText;
                                    contentField.focus();
                                    contentField.setSelectionRange(startPos + refText.length, startPos + refText.length);
                                    
                                    // 更新预览
                                    updatePreview();
                                    
                                    // 显示提示
                                    const toast = document.createElement('div');
                                    toast.className = 'position-fixed bottom-0 right-0 p-3';
                                    toast.style.zIndex = '5';
                                    toast.innerHTML = `
                                        <div class="toast show" role="alert">
                                            <div class="toast-body">
                                                已插入图片引用: ${refText}
                                            </div>
                                        </div>
                                    `;
                                    document.body.appendChild(toast);
                                    
                                    setTimeout(() => {
                                        document.body.removeChild(toast);
                                    }, 2000);
                                });
                                
                                // 添加删除按钮点击事件
                                const deleteBtn = colDiv.querySelector('.delete-img-btn');
                                deleteBtn.addEventListener('click', function() {
                                    // 从uploadedImages数组中移除该图片
                                    uploadedImages = uploadedImages.filter(img => img.id !== imageId);
                                    
                                    // 从DOM中移除该图片预览
                                    imagePreviewRow.removeChild(colDiv);
                                    
                                    // 更新隐藏字段
                                    const previousImagesInput = document.getElementById('previous_images');
                                    if (previousImagesInput) {
                                        const imageIds = uploadedImages.map(img => img.id).join(',');
                                        previousImagesInput.value = imageIds;
                                    }
                                    
                                    // 显示删除提示
                                    const toast = document.createElement('div');
                                    toast.className = 'position-fixed bottom-0 right-0 p-3';
                                    toast.style.zIndex = '5';
                                    toast.innerHTML = `
                                        <div class="toast show" role="alert">
                                            <div class="toast-body">
                                                已删除图片 ID: ${imageId}
                                            </div>
                                        </div>
                                    `;
                                    document.body.appendChild(toast);
                                    
                                    setTimeout(() => {
                                        document.body.removeChild(toast);
                                    }, 2000);
                                });
                            };
                            
                            reader.readAsDataURL(file);
                        }
                    });
                    
                    // 更新隐藏字段，存储所有图片ID
                    const previousImagesInput = document.getElementById('previous_images');
                    if (previousImagesInput) {
                        const imageIds = uploadedImages.map(img => img.id).join(',');
                        previousImagesInput.value = imageIds;
                    }
                });
                
                // 表单提交前处理
                // 使用更精确的选择器来选择文章创建表单
                const form = document.querySelector('form[method="POST"]');
                console.log('找到文章创建表单元素:', form);
                
                // 检查表单是否有submit事件监听器
                if (form) {
                    console.log('表单存在，添加submit事件监听器');
                    
                    // 移除可能存在的旧事件监听器
                    form.removeEventListener('submit', handleFormSubmit);
                    
                    // 添加新的事件监听器
                    form.addEventListener('submit', handleFormSubmit);
                } else {
                    console.error('未找到表单元素');
                }
                
                // 表单提交处理函数
                function handleFormSubmit(e) {
                    console.log('表单提交事件被触发');
                    
                    // 阻止表单默认提交行为
                    e.preventDefault();
                    
                    console.log('=== 表单提交调试信息 ===');
                    
                    // 获取文章内容，找出所有被引用的图片ID
                    const content = contentField.value;
                    const referencedImgIds = new Set();
                    const imgIdRegex = /\[\[img_id=(\d+)\]\]/g;
                    let match;
                    
                    while ((match = imgIdRegex.exec(content)) !== null) {
                        referencedImgIds.add(match[1]);
                    }
                    
                    console.log('文章内容长度:', content.length);
                    console.log('引用的图片ID:', Array.from(referencedImgIds));
                    
                    // 创建新的文件列表，只包含被引用的图片
                    const referencedFiles = [];
                    
                    uploadedImages.forEach(img => {
                        if (referencedImgIds.has(img.id.toString()) && img.file) {
                            referencedFiles.push(img.file);
                        }
                    });
                    
                    console.log('引用的图片文件数量:', referencedFiles.length);

                    // 只提交被引用的图片文件
                    // 先移除原有的文件输入
                    const originalImageInput = document.getElementById('images');
                    if (originalImageInput) {
                        const newImageInput = originalImageInput.cloneNode(false);
                        originalImageInput.parentNode.replaceChild(newImageInput, originalImageInput);
                        
                        // 添加被引用的图片到新的输入
                        const dataTransfer = new DataTransfer();
                        referencedFiles.forEach(file => {
                            dataTransfer.items.add(file);
                        });
                        newImageInput.files = dataTransfer.files;
                        console.log('更新后的图片输入文件数量:', newImageInput.files.length);
                    }

                    // 添加图片ID映射信息到表单
                    // 告诉服务器前端分配的ID顺序
                    const imageIdMapping = referencedFiles.map(file => {
                        const img = uploadedImages.find(img => img.file === file);
                        return img ? img.id : null;
                    }).filter(id => id !== null);

                    // 移除旧的映射字段
                    const oldMappingInput = form.querySelector('input[name="image_id_mapping"]');
                    if (oldMappingInput) oldMappingInput.remove();

                    // 添加新的映射字段
                    const mappingInput = document.createElement('input');
                    mappingInput.type = 'hidden';
                    mappingInput.name = 'image_id_mapping';
                    mappingInput.value = JSON.stringify(imageIdMapping);
                    form.appendChild(mappingInput);
                    console.log('图片ID映射:', imageIdMapping);

                    // 检查已上传文件列表
                    const allFileCheckboxes = document.querySelectorAll('.file-checkbox');
                    console.log('所有文件复选框数量:', allFileCheckboxes.length);
                    
                    allFileCheckboxes.forEach((checkbox, index) => {
                        console.log(`文件复选框 ${index}:`, {
                            value: checkbox.value,
                            checked: checkbox.checked,
                            parentElement: checkbox.parentElement.textContent.trim()
                        });
                    });
                    
                    // 清除之前添加的文件ID隐藏字段
                    const existingFileInputs = form.querySelectorAll('input[name="selected_files"]');
                    console.log('清除旧的文件ID隐藏字段数量:', existingFileInputs.length);
                    existingFileInputs.forEach(input => input.remove());
                    
                    // 添加选中的文件ID到表单中
                    const selectedFileInputs = document.querySelectorAll('.file-checkbox:checked');
                    console.log('选中的文件复选框数量:', selectedFileInputs.length);
                    
                    const selectedFileIds = [];
                    selectedFileInputs.forEach(checkbox => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'selected_files';
                        input.value = checkbox.value;
                        form.appendChild(input);
                        selectedFileIds.push(checkbox.value);
                        console.log('添加文件ID到表单:', checkbox.value);
                    });
                    
                    console.log('最终选中的文件ID列表:', selectedFileIds);
                    
                    // 检查表单数据
                    const formData = new FormData(form);
                    const formSelectedFiles = formData.getAll('selected_files');
                    console.log('表单中的selected_files值:', formSelectedFiles);
                    
                    console.log('=== 表单提交调试信息结束 ===');
                    
                    // 手动提交表单
                    form.submit();
                }
                
                // 文件上传功能
                const fileUploadInput = document.getElementById('file-upload');
                const uploadProgressContainer = document.getElementById('upload-progress-container');
                const uploadProgressList = document.getElementById('upload-progress-list');
                const uploadedFilesList = document.getElementById('uploaded-files-list');
                
                // 文件上传状态跟踪
                const uploadStates = {};
                // 文件ID与进度条元素的关联
                const fileProgressItems = {};
                
                // 格式化文件大小
                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
                
                // 监听文件选择
                fileUploadInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    
                    if (files.length === 0) {
                        document.querySelector('.custom-file-label').textContent = '选择文件...';
                        return;
                    }
                    
                    // 更新文件名显示
                    if (files.length === 1) {
                        document.querySelector('.custom-file-label').textContent = files[0].name;
                    } else {
                        document.querySelector('.custom-file-label').textContent = `已选择 ${files.length} 个文件`;
                    }
                    
                    // 显示上传进度容器
                    uploadProgressContainer.style.display = 'block';
                    
                    // 上传每个文件
                    files.forEach(file => {
                        uploadFile(file);
                    });
                    
                    // 重置文件输入
                    fileUploadInput.value = '';
                });
                
                // 上传单个文件
                function uploadFile(file) {
                    const fileId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    
                    // 创建进度条元素
                    const progressItem = document.createElement('div');
                    progressItem.className = 'mb-3';
                    progressItem.id = fileId;
                    progressItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size text-muted">${formatFileSize(file.size)}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span class="upload-status text-muted">准备上传...</span>
                            <button type="button" class="btn btn-sm btn-outline-danger cancel-upload-btn">取消</button>
                        </div>
                    `;
                    
                    uploadProgressList.appendChild(progressItem);
                    
                    // 获取进度条元素
                    const progressBar = progressItem.querySelector('.progress-bar');
                    const statusText = progressItem.querySelector('.upload-status');
                    const cancelBtn = progressItem.querySelector('.cancel-upload-btn');
                    
                    // 创建XMLHttpRequest对象
                    const xhr = new XMLHttpRequest();
                    uploadStates[fileId] = { xhr, cancelled: false };
                    
                    // 监听上传进度
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = Math.round((e.loaded / e.total) * 100);
                            progressBar.style.width = percentComplete + '%';
                            progressBar.setAttribute('aria-valuenow', percentComplete);
                            progressBar.textContent = percentComplete + '%';
                            statusText.textContent = `上传中... ${percentComplete}%`;
                        }
                    });
                    
                    // 监听上传完成
                    xhr.addEventListener('load', function() {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                console.log('文件上传成功:', response);
                                progressBar.classList.remove('progress-bar-animated');
                                progressBar.classList.add('bg-success');
                                statusText.textContent = '上传成功';
                                cancelBtn.textContent = '删除';
                                cancelBtn.classList.remove('cancel-upload-btn');
                                cancelBtn.classList.add('delete-file-btn');
                                cancelBtn.setAttribute('data-file-id', response.file_id);
                                
                                // 记录文件ID与进度条元素的关联
                                fileProgressItems[response.file_id] = progressItem;
                                
                                // 添加到已上传文件列表
                                addUploadedFileToList(response);
                                
                                // 验证文件是否正确添加到列表
                                setTimeout(() => {
                                    const addedCheckbox = document.querySelector(`.file-checkbox[value="${response.file_id}"]`);
                                    if (addedCheckbox) {
                                        console.log('文件已正确添加到列表:', response.file_id);
                                    } else {
                                        console.error('文件未添加到列表:', response.file_id);
                                    }
                                }, 100);
                            } else {
                                progressBar.classList.add('bg-danger');
                                statusText.textContent = '上传失败: ' + response.error;
                                cancelBtn.textContent = '重试';
                                cancelBtn.classList.remove('cancel-upload-btn');
                                cancelBtn.classList.add('retry-upload-btn');
                            }
                        } else {
                            progressBar.classList.add('bg-danger');
                            statusText.textContent = '上传失败: 服务器错误';
                            cancelBtn.textContent = '重试';
                            cancelBtn.classList.remove('cancel-upload-btn');
                            cancelBtn.classList.add('retry-upload-btn');
                        }
                    });
                    
                    // 监听上传错误
                    xhr.addEventListener('error', function() {
                        progressBar.classList.add('bg-danger');
                        statusText.textContent = '上传失败: 网络错误';
                        cancelBtn.textContent = '重试';
                        cancelBtn.classList.remove('cancel-upload-btn');
                        cancelBtn.classList.add('retry-upload-btn');
                    });
                    
                    // 取消上传按钮事件
                    cancelBtn.addEventListener('click', function() {
                        if (cancelBtn.classList.contains('cancel-upload-btn')) {
                            // 取消上传
                            uploadStates[fileId].cancelled = true;
                            xhr.abort();
                            uploadProgressList.removeChild(progressItem);
                            delete uploadStates[fileId];
                        } else if (cancelBtn.classList.contains('retry-upload-btn')) {
                            // 重试上传
                            progressBar.classList.remove('bg-danger');
                            progressBar.classList.add('progress-bar-animated');
                            progressBar.style.width = '0%';
                            progressBar.setAttribute('aria-valuenow', 0);
                            progressBar.textContent = '0%';
                            statusText.textContent = '准备上传...';
                            cancelBtn.textContent = '取消';
                            cancelBtn.classList.remove('retry-upload-btn');
                            cancelBtn.classList.add('cancel-upload-btn');
                            uploadFile(file);
                        } else if (cancelBtn.classList.contains('delete-file-btn')) {
                            // 删除已上传的文件
                            const file_id = cancelBtn.getAttribute('data-file-id');
                            // 查找对应的已上传文件项
                            const fileItem = document.getElementById('file-item-' + file_id);
                            deleteUploadedFile(file_id, fileItem);
                        }
                    });
                    
                    // 准备表单数据
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                    
                    // 发送请求
                    xhr.open('POST', '{% url "article:upload_file" %}', true);
                    xhr.send(formData);
                }
                
                // 添加已上传文件到列表
                function addUploadedFileToList(fileData) {
                    console.log('添加文件到列表:', fileData);
                    console.log('fileData.file_id:', fileData.file_id);
                    console.log('fileData.id:', fileData.id);
                    console.log('fileData对象的所有键:', Object.keys(fileData));
                    
                    // 确定使用哪个字段作为文件ID
                    const fileId = fileData.file_id || fileData.id;
                    console.log('最终使用的文件ID:', fileId);
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    fileItem.id = 'file-item-' + fileId;
                    fileItem.innerHTML = `
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="form-check-input file-checkbox mr-2" value="${fileId}" checked>
                            <div>
                                <div class="font-weight-medium">${fileData.filename}</div>
                                <small class="text-muted">${formatFileSize(fileData.file_size)}</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn" data-file-id="${fileId}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    uploadedFilesList.appendChild(fileItem);
                    
                    // 验证文件是否正确添加
                    const addedCheckbox = fileItem.querySelector('.file-checkbox');
                    console.log('文件复选框已添加:', {
                        value: addedCheckbox.value,
                        checked: addedCheckbox.checked,
                        parentElement: uploadedFilesList
                    });
                    
                    // 添加删除按钮事件
                    const deleteBtn = fileItem.querySelector('.delete-file-btn');
                    deleteBtn.addEventListener('click', function() {
                        const fileId = fileData.file_id || fileData.id;
                        deleteUploadedFile(fileId, fileItem);
                    });
                }
                
                // 删除已上传的文件
                function deleteUploadedFile(fileId, fileItem) {
                    fetch(`/article/delete-temp-file/${fileId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: '_method=DELETE'
                    })
                    .then(response => {
                        // 检查响应状态
                        if (!response.ok) {
                            throw new Error(`HTTP错误! 状态: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // 安全地从已上传文件列表中删除
                            if (fileItem && fileItem.parentNode === uploadedFilesList) {
                                uploadedFilesList.removeChild(fileItem);
                            }
                            
                            // 从上传进度列表中删除
                            const progressItem = fileProgressItems[fileId];
                            if (progressItem && progressItem.parentNode === uploadProgressList) {
                                uploadProgressList.removeChild(progressItem);
                                delete fileProgressItems[fileId];
                            }
                        } else {
                            alert('删除文件失败: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('删除文件错误:', error);
                        alert('删除文件时发生网络错误: ' + error.message);
                    });
                }
                
                // 加载已有的临时文件
                function loadExistingFiles() {
                    console.log('开始加载已有文件...');
                    fetch('{% url "article:get_temp_files" %}', {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('获取文件列表响应:', data);
                        if (data.success) {
                            console.log('加载到的文件数量:', data.files.length);
                            data.files.forEach((file, index) => {
                                console.log(`处理文件 ${index}:`, file);
                                addUploadedFileToList(file);
                            });
                            
                            // 验证文件是否正确添加到列表
                            setTimeout(() => {
                                const allCheckboxes = document.querySelectorAll('.file-checkbox');
                                console.log('页面加载后，文件复选框总数:', allCheckboxes.length);
                                allCheckboxes.forEach((checkbox, index) => {
                                    console.log(`文件复选框 ${index}:`, {
                                        value: checkbox.value,
                                        checked: checkbox.checked
                                    });
                                });
                            }, 500);
                        } else {
                            console.error('获取文件列表失败:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('加载文件列表错误:', error);
                    });
                }
                
                // 页面加载时获取已有的临时文件
                loadExistingFiles();
                
                // 添加发布按钮点击事件作为备用方案
                // 使用更精确的选择器来选择发布按钮
                const submitBtn = document.querySelector('button[type="submit"]:has(i.fa-save)');
                console.log('找到发布按钮:', submitBtn);
                
                if (submitBtn) {
                    submitBtn.addEventListener('click', function(e) {
                        console.log('发布按钮被点击');
                        
                        // 延迟执行，确保表单提交事件有时间处理
                        setTimeout(() => {
                            // 检查是否有选中的文件
                            const selectedCheckboxes = document.querySelectorAll('.file-checkbox:checked');
                            console.log('发布按钮点击时选中的文件数量:', selectedCheckboxes.length);
                            
                            if (selectedCheckboxes.length > 0) {
                                const fileIds = [];
                                selectedCheckboxes.forEach(checkbox => {
                                    fileIds.push(checkbox.value);
                                });
                                console.log('发布按钮点击时选中的文件ID:', fileIds);
                            }
                        }, 100);
                    });
                }
            } // 闭合 if (imageInput && imagePreviewRow) 块
        } // 闭合 if (contentField && previewDiv) 块
    }); // 闭合 document.addEventListener 块
</script>
{% endblock %}